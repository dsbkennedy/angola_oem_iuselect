---
title: "Commune Analysis"
author: "Dave Kennedy"
date: "24/02/2022"
output:
  html_document: 
  keep_md: yes
---

```{r setup}
knitr::opts_chunk$set(
	echo = FALSE,
	fig.asp = 0.8,
	fig.height = 12,
	fig.retina = 2,
	fig.width = 12,
	include=FALSE,
	warning = FALSE,
	cache = TRUE,
	dev = "png",
	dpi = 300,
	include = FALSE,
	out.width = "100%"
)
require(pacman)
library(tidyverse)
pacman::p_load(raster, sf, exactextractr, here,
               readxl, tidyxl, unpivotr,
               leaflet, leaflet.extras, 
               janitor, patchwork,RColorBrewer,
               ggsflabel,broom,kableExtra,ggthemes,
               ggsn,gghighlight,ggsflabel,ggbeeswarm,
               data.table,linelist,tidylog, patchwork)

commune_palette <- colorRampPalette(rev(brewer.pal(6, "Spectral")))
commune_fill <- scale_fill_stepsn(n.breaks = 6, colours = viridis::viridis(6), limits=c(1, 100))
```

```{r data-wrangling}
# Import shapefiles 
iu_shp <-
  read_sf(here('data', 'input', 'shp', 'ESPEN_IU_2020.shp')) %>%
  filter(ADMIN0 == 'Angola') %>% 
  select(IU_ID,ADMIN1, ADMIN2, geometry)

# 164 implementation units

commune_shp <- read_sf(here('data', 'input', 'shp', 'ago_admbnda_adm3_gadm_ine_ocha_20180904.shp')) %>% 
  select(ADM1_EN, ADM1_PCODE, ADM2_EN,ADM2_PCODE, ADM3_EN,ADM3_PCODE, geometry) %>% 
    clean_data()

adm1_shp <- commune_shp %>%
  group_by(adm1_en) %>%
  summarise()


# 539 communes 


# 18 provinces 

source(here('admin_db.R'))

commune_shp_linked <- commune_shp %>% 
  inner_join(final_linked_db %>% 
              select('adm1_pcode', 'adm2_pcode', 'adm3_pcode','iu_id', 'total_pop'),
            by=c('adm1_pcode', 'adm2_pcode', 'adm3_pcode')) %>% 
                 distinct(adm1_pcode, adm2_pcode, adm3_pcode, .keep_all=TRUE)


# Import oncho data from ESPEN
oncho_wd <-
  read.csv(here('data', 'input', 'espen_platform_oncho.csv')) %>%
  filter(Year == 2020) %>% 
  select(IU_ID, Endemicity, population=PopTot) 

# 164 IUs

loa_loa_wd <-
  read.csv(here('data', 'input', 'espen_platform_loaloa.csv')) %>% 
  filter(Year==2020) %>% 
  select(IU_ID, loaloa_status=Endemicity)
# 164 IUs

lf_wd <- read.csv(here('data', 'input', 'espen_platform_lf.csv')) %>% 
    filter(Year==2020) %>% 
  select(IU_ID, lf_status=Endemicity)

oncho_loa_loa_lf_data <- oncho_wd %>% 
    left_join(loa_loa_wd, by=c('IU_ID')) %>% 
      left_join(lf_wd, by=c('IU_ID')) 

unknown_commune_shp <- commune_shp_linked %>% 
    left_join(oncho_loa_loa_lf_data, by=c('iu_id' = 'IU_ID')) %>% 
  #left_join(oncho_wd, by=c('iu_id' = 'IU_ID')) %>% 
  filter(grepl('Unknown', Endemicity)) 
  #select(-Endemicity) %>% 
  #left_join(loa_loa_wd, by=c('iu_id' = 'IU_ID')) 
  #mutate(oncho_status="Unknown")
  
unknown_commune_shp %>% 
  as_tibble() %>%
  #filter(loaloa_status=="Non-endemic") %>% 
    tabyl(Endemicity,lf_status) %>%
    adorn_totals(c("row", "col")) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(rounding = "half up", digits = 0) %>%
  adorn_ns() %>%
  adorn_title("combined")
  
length(unique(unknown_commune_shp$adm1_en))
length(unique(unknown_commune_shp$adm2_en))
length(unique(unknown_commune_shp$adm3_en))


```

```{r map-angola-commune}
# Map to check data
iu_commune_map_labels <- adm1_shp %>%
  ggplot() +
  geom_sf(fill = "transparent", color = "black", size = 1.5) +
  geom_sf_label(aes(label = adm1_en))

iu_commune_map_labels

commune_map <- commune_shp %>%
  ggplot() +
  geom_sf(fill = "transparent", color = "red", size = 0.5) +
     geom_sf(fill = "transparent", color = "black", size = 1.5,
            data=adm1_shp)

commune_map

endemicity_labels <- oncho_wd %>% tabyl(Endemicity) %>% pull(Endemicity)

scale_fill_end <- function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c('green', 'blue', 'red', 'orange'), 
                          endemicity_labels), 
        ...
    )
}

iu_commune_endemicity <- iu_shp %>% 
  left_join(oncho_wd, by='IU_ID') %>% 
  ggplot() +
  geom_sf(aes(fill = Endemicity),
    size = 0.05) +
        geom_sf(fill = "transparent", color = "black", size = 1.5,
            data=adm1_shp) +
  labs(fill="Oncohcerciasis Endemicity") +
        theme(legend.position = c(0.85, 0.9)) +
  scale_fill_end()


iu_commune_endemicity

iu_commune_map <- unknown_commune_shp %>%
  ggplot() +
  geom_sf(aes(fill = Endemicity)) +
    geom_sf(fill = "transparent", color = "black", size = 1.5,
            data=adm1_shp) +
  labs(fill="Oncohcerciasis Endemicity") +
        theme(legend.position = c(0.85, 0.9)) +
    scale_fill_end()

iu_commune_map

```
```{r neighbour-polygons}

# Want to identify communes neighbouring endemic communes

polygon_endemicity_shp <- commune_shp_linked %>% 
    left_join(oncho_loa_loa_lf_data, by=c('iu_id' = 'IU_ID')) %>% 
  mutate(endemicity_bin=case_when(grepl('Endemic', Endemicity) ~ 'Endemic',
                              TRUE ~ "Unknown")) %>% 
  select(adm1_en, adm2_en, adm3_en, endemicity_bin, geometry) %>% 
    mutate(polygon_id = row_number())


neighbors <- st_touches(polygon_endemicity_shp) %>% 
  as.data.frame() %>% 
  select(polygon_id=row.id, neighbour_polygon_id=col.id) %>% 
  group_by(polygon_id) %>% 
  mutate(neighbour_count = paste('poly_neighbour', dplyr::row_number(), sep='_')) %>% 
  pivot_wider(names_from=neighbour_count, values_from=neighbour_polygon_id)
  

polygon_endemicity_neighbours_shp <- polygon_endemicity_shp %>% 
  left_join(neighbors, by='polygon_id')

endemic_poly <- polygon_endemicity_neighbours_shp %>% filter(grepl('Endemic', endemicity_bin)) %>% pull(polygon_id)
  
endemic_neighbour <- polygon_endemicity_neighbours_shp %>% filter(grepl('Endemic', endemicity_bin)) %>% 
  as_tibble() %>% 
  select(polygon_id, starts_with('poly_neighbour')) %>% 
  pivot_longer(-polygon_id) %>% 
  filter(!is.na(value)) %>% 
  distinct(value) %>% 
  arrange(value) %>% 
  pull(value)

endemic_neighbour_filtered <- setdiff(endemic_neighbour, endemic_poly)

#Need to filter endemic neighbour on endemic poly
neighbour_endemic_area <- polygon_endemicity_shp %>% 
  filter(polygon_id %in% endemic_neighbour_filtered) %>% 
  select(-c(polygon_id, geometry))

neighbour_endemic_area_map <- neighbour_endemic_area %>% 
  ggplot() +
  geom_sf(aes(fill = endemicity_bin),
    size = 0.05) +
        geom_sf(fill = "transparent", color = "black", size = 1.5,
            data=adm1_shp) +
  labs(fill="Oncohcerciasis Endemicity") +
        theme(legend.position = c(0.85, 0.9)) 


```

```{r raster-wrangling}

#Import environmental suitability as raster data
africa_oncho_rs <-
  stack(here('data', 'IHME_AFRICA_ONCHO_ENV_SUIT_MEAN_Y2020M08D26.TIF'))

#Crop raster to shapefile of communes within IUs with unknown endemicity
unknown_iu_oncho_combined <-
  exact_extract(africa_oncho_rs,
                unknown_commune_shp,
                progress = FALSE)  %>%
  bind_rows(., .id = "id") %>%
  as_tibble() %>% 
  mutate(id = as.numeric(id)) %>%
  #--- group summary ---#
  filter(!is.na(value))

# Merge raster values with shapefile
angola_commune_oncho <- unknown_commune_shp %>%
  mutate(id := seq_len(nrow(.))) %>%
  left_join(., unknown_iu_oncho_combined, by = "id") 

```

```{r}
#Calculate weighted mean
# angola_commune_oncho_collapse <- angola_commune_oncho %>%
#   group_by(adm1_en, adm2_en, adm3_en) %>%
#   summarise(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))  

angola_commune_oncho_collapse <- setDT(angola_commune_oncho)[, keyby = .(adm1_en, adm2_en, adm3_en), 
                          .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%  
  merge(unknown_commune_shp, all=TRUE, by = c('adm1_en', 'adm2_en','adm3_en')) %>% 
  st_as_sf()

# y <- merge(unknown_commune_shp, angola_commune_oncho_collapse, all = TRUE, by = "Id")
# 
# angola_commune_oncho_collapse <- merge(unknown_commune_shp, angola_commune_oncho_summary, all.x = TRUE, by = c('adm1_en', 'adm2_en','adm3_en'))

# Map weighted mean by ADM3  
angola_commune_oncho_noloaloa_map <- angola_commune_oncho_collapse %>% 
  ggplot() +
  geom_sf(aes(fill = oncho_mean_aw)) +
     geom_sf(fill = "transparent", color = "black", size = 1.5,
          data = adm1_shp) +
  labs(fill="Environmental suitability (Mean)") +
  theme(legend.position = "top") +
  commune_fill

angola_commune_oncho_noloaloa_map
```



Check environmental suitability by Loa loa endemicity

```{r loa-loa}

(oncho_env_loaloa_compare <- ggplot(data=angola_commune_oncho %>% filter(grepl("Unknown", Endemicity)), 
                                    aes(x=value, group=loaloa_status, fill=loaloa_status)) +
    geom_density(adjust=1.5, alpha=.4) +
    labs(x="Environmental suitability", fill="Loa loa status"))
  
#oncho_env_loaloa_compare
 (oncho_env_loaloa_ttest <- t.test(value ~ loaloa_status, 
                                   data = angola_commune_oncho %>% filter(grepl("Unknown", Endemicity)), 
                                   var.equal = TRUE) %>% 
    tidy())
  
```

```{r env-suit-threshold}
angola_commune_oncho_noloaloa_over71<- setDT(angola_commune_oncho)[
  loaloa_status == "Non-endemic"] %>%  
  mutate(over71=case_when(value>=71 ~ 1, 
                          TRUE ~ 0)) %>% 
  count(adm1_en, adm2_en, adm3_en,over71) %>% 
  group_by(adm1_en, adm2_en, adm3_en) %>% 
  mutate(propover71=100*(n/sum(n))) %>% 
  filter(over71==1) %>% 
  #summarise(total_over71=sum(over71)) %>% 
  merge(unknown_commune_shp, by = c('adm1_en', 'adm2_en','adm3_en')) %>% 
  st_as_sf()

angola_commune_oncho_noloaloa_over71_map <- angola_commune_oncho_noloaloa_over71 %>% 
  ggplot() +
  geom_sf(aes(fill = propover71)) +
     geom_sf(fill = "transparent", color = "black", size = 1.5,
          data = adm1_shp) +
     labs(fill="% of pixels (5x5km) in a commune exceeding environmental threshold >=0.71") +
  theme(legend.position = "top") +
    scale_fill_viridis_c(option = "magma", begin=0, end=1)

angola_commune_oncho_noloaloa_over71_map

```


```{r country-commune-noloaloa-map}
#Calculate weighted mean
angola_commune_oncho_noloaloa_collapse <- setDT(angola_commune_oncho)[
  loaloa_status == "Non-endemic"] [
  , keyby = .(adm1_en, adm2_en, adm3_en), 
                          .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%  
  merge(unknown_commune_shp, by = c('adm1_en', 'adm2_en','adm3_en')) %>% 
  st_as_sf()

# Map weighted mean by ADM3  
(angola_commune_oncho_noloaloa_map <- angola_commune_oncho_noloaloa_collapse %>% 
  ggplot() +
  geom_sf(aes(fill = oncho_mean_aw)) +
     geom_sf(fill = "transparent", color = "black", size = 1.5, 
          data = adm1_shp) +
     labs(fill="Environmental suitability (Mean)") +
  theme(legend.position = "top") +
  commune_fill)

commune_boxwhisker <- angola_commune_oncho %>% 
  filter(loaloa_status == "Non-endemic") %>% 
  mutate(location_name=paste(adm1_en,adm2_en, sep= "-")) %>% 
  split(.$location_name) %>%
  imap(~ ggplot(data=.x) +
        geom_boxplot(aes(value, reorder(adm3_en,desc(adm3_en)))) + 
        theme_bw() +
        scale_x_continuous(limits=c(0,100),sec.axis = dup_axis()) +
        labs(x='Environmental suitability', 
             y='Commune') +
          ggtitle(.y) 
  )


commune_map <-  angola_commune_oncho_noloaloa_collapse %>%
  as.data.frame() %>% 
  st_as_sf() %>% 
  mutate(location_name=paste(adm1_en,adm2_en, sep= "-")) %>% 
  split(.$location_name) %>%
  imap(~ ggplot(data = .x) +
      geom_sf(aes(fill = oncho_mean_aw)) +
      geom_sf_label_repel(aes(label = adm3_en)) +
        labs(fill="Environmental suitability (Mean)") +
      theme(legend.position = 'top') +
      labs(x = "", y = "", fill = "Environmental suitability") +
      commune_fill +
      ggtitle(.y)
  )

commune_col <- angola_commune_oncho_noloaloa_collapse %>% 
  as_tibble() %>% 
  mutate(location_name=paste(adm1_en,adm2_en, sep= "-")) %>% 
  split(.$location_name) %>%
  imap(~ ggplot(data=.x) +
         geom_col(aes(x=adm3_en, y=total_pop)) +
       theme_bw() +
  scale_y_continuous(labels = scales::unit_format(unit = "K", scale = 1e-3)) +
         labs(x='Commune', 
              y='Popoulation') +
         ggtitle(.y) +
    coord_flip()
  )


all_plots <- c()
for (i in 1:80) {
 x <-  (commune_map[[i]] + commune_col[[i]]) / commune_boxwhisker[[i]]
 all_plots[[length(all_plots) + 1]] <- x    # Append new list element
}

```


```{r province-plots, eval=FALSE, include=FALSE}
province_map <-  angola_commune_oncho_noloaloa_collapse %>%
  as.data.frame() %>% 
  st_as_sf() %>% 
  #mutate(location_name=paste(adm1_en,adm2_en, sep= "-")) %>% 
  split(.$adm1_en) %>%
  imap(~ ggplot(data = .x) +
      geom_sf(aes(fill = oncho_mean_aw)) +
      geom_sf_label_repel(aes(label = adm3_en)) +
        labs(fill="Environmental suitability (Mean)") +
      theme(legend.position = 'top') +
      labs(x = "", y = "", fill = "Environmental suitability") +
      commune_fill +
      ggtitle(.y)
  )
province_map
```


```{r commune-plots, eval=FALSE, include=FALSE}
all_plots
```


```{r additional-filtering}
library(viridis)  # Load viridis for the viridis palette
#Calculate weighted mean
oem_map_cat_df <- setDT(angola_commune_oncho)[
  loaloa_status == "Non-endemic"] [
    , keyby = .(adm1_en, adm2_en, adm3_en), 
    .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%  
  merge(unknown_commune_shp, by = c('adm1_en', 'adm2_en','adm3_en')) %>% 
  st_as_sf()  %>% 
    as_tibble() %>% 
  st_as_sf() %>% 
  #filter(oncho_mean_aw>=71) %>% 
  mutate(env_suit_cat = case_when (oncho_mean_aw >= 80 ~ '80+',
                                   oncho_mean_aw >=60 & oncho_mean_aw <80 ~ '60-80',
                                   oncho_mean_aw >=40 & oncho_mean_aw<60 ~ '40-60', 
                                   oncho_mean_aw >=20 & oncho_mean_aw <40~ '20-40', 
                                   oncho_mean_aw <20 ~ '<20')) 

oem_map_cat_plot <- oem_map_cat_df %>% as_tibble() %>% 
  count(adm1_en,env_suit_cat) %>% 
  ggplot() +
  geom_col(aes(x=reorder(adm1_en,desc(adm1_en)), y=n, fill=forcats::fct_rev(env_suit_cat))) +
  coord_flip() +
  labs(x='', y='', fill='Environmental suitability')

oem_map_cat_plot

oem_map_cat_map <- oem_map_cat_df %>%   
  #tabyl(env_suit_cat) %>% 
  ggplot() + 
  geom_sf(aes(fill = env_suit_cat)) +
  geom_sf(fill = "transparent", color = "black", size = 1.5,
          data = adm1_shp) +
  labs(fill="Environmental suitability (Mean)") +
  theme(legend.position = "top") +
    scale_fill_viridis(discrete = TRUE)

oem_map_cat_map

```

```{r joining-questionnaire-data, eval=FALSE, include=FALSE}
# library(openxlsx)
# iu_questionnaire <- openxlsx::read.xlsx(here::here('data', 'input', 'Angola_List_IUs.xlsx'), sheet='Questionnaire',
#                                       fillMergedCells = TRUE, colNames = FALSE)
# 
# names(iu_questionnaire) <- paste(names(iu_questionnaire), iu_questionnaire[2, ], sep = "_")
# 
# iu_questionnaire_final <- slice(iu_questionnaire, -(1:2)) %>% clean_data() %>% 
#   mutate(iu_id=as.integer(x5_administrative_iu_id))
# 
# commune_questionnaire <- setDT(angola_commune_oncho)[
#   loaloa_status == "Non-endemic"] [
#     , keyby = .(adm1_en, adm2_en, adm3_en, iu_id, total_pop, Endemicity), 
#     .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%   
#   as_tibble() %>% 
#   select(adm1_en, adm2_en, adm3_en, iu_id, total_pop, Endemicity, oncho_mean_aw) %>%  
#   left_join(iu_questionnaire_final,by=c('iu_id'))


library(openxlsx)
iu_questionnaire <- openxlsx::read.xlsx(here::here('data', 'input', 'Angola_List_IUs.xlsx'), sheet='Questionnaire',
                                      fillMergedCells = TRUE, colNames = FALSE)


names(iu_questionnaire) <- paste(names(iu_questionnaire), iu_questionnaire[2, ], sep = "_")

iu_questionnaire_final <- slice(iu_questionnaire, -(1:2)) %>% clean_data() 
  mutate(iu_id=as.integer(x5_administrative_iu_id))
  
questionnaire_template <- read.csv(here::here('data', 'input', 'questionnaire_template.csv')) %>% slice(1)

commune_questionnaire <- setDT(angola_commune_oncho)[
  loaloa_status == "Non-endemic"] [
    , keyby = .(adm1_en, adm2_en, adm3_en, iu_id, total_pop, Endemicity), 
    .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%   
  as_tibble() %>% 
  select(adm1_en, adm2_en, adm3_en, iu_id, total_pop, Endemicity, oncho_mean_aw) %>%  
  left_join(iu_questionnaire_final,by=c('iu_id'))

commune_questionnaire <- setDT(angola_commune_oncho)[
  loaloa_status == "Non-endemic"] [
    , keyby = .(adm1_en, adm2_en, adm3_en, iu_id,adm3_pcode, total_pop, Endemicity), 
    .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%   
  as_tibble() %>% 
  bind_cols(questionnaire_template) %>% 
  arrange(adm1_en,adm2_en,oncho_mean_aw)

write.csv(commune_questionnaire,here::here('data', 'output', 'commune_questionnaire.csv'))

length(is.na(commune_questionnaire$total_pop))

commune_questionnaire %>% tabyl(total_pop)


```

```{r mapping-mosquito-sites, eval=FALSE, include=FALSE}

mosquito_sampling_sites <- read.csv(here('data', 'input', 'mentor_mosquito_sampling_sites.csv'))

mosquito_sampling_sf <- mosquito_sampling_sites %>% 
  st_as_sf(coords=c('latitude', 'longitude'))

angola_oncho_mosquito_map <- angola_commune_oncho_noloaloa_collapse %>% 
  filter(adm1_en %in% c('benguela', 'cuanza_sul')) %>% 
  #filter(adm2_en %in% c('benguela', 'ganda', 'sumbe', 'quibala'))
  ggplot() +
  geom_sf(aes(fill = oncho_mean_aw)) +
  geom_sf(fill = "transparent", color = "black", size = 1.5,
          data = adm1_shp) +
  geom_point(
    data = mosquito_sampling_sites, aes(x = longitude, y = latitude),
    fill = "red", color = "red", alpha =1, size=4
  ) +
  geom_text(
    data = mosquito_sampling_sites,
    aes(x = longitude, y = latitude,label=sentinel.site),color="red", 
    nudge_x = 0.25, nudge_y = 0.25, 
    check_overlap = T
  ) +
  labs(fill="Environmental suitability (Mean)") +
  theme(legend.position = "top") +
  commune_fill
#angola_oncho_mosquito_map




province_oncho_mosquito_map <- angola_commune_oncho_collapse %>% 
  filter(adm1_en %in% c('benguela', 'cuanza_sul')) %>% 
  #filter(adm2_en %in% c('benguela', 'ganda', 'sumbe', 'quibala'))
  ggplot() +
  geom_sf(aes(fill = oncho_mean_aw)) +
  #geom_sf_label_repel(aes(label = adm2_en)) +
  geom_point(
    data = mosquito_sampling_sites, aes(x = longitude, y = latitude),
    fill = "red", color = "red", alpha =1, size=4
  ) +
  geom_text(
    data = mosquito_sampling_sites,
    aes(x = longitude, y = latitude,label=sentinel.site),color="red", 
    nudge_x = 0.15, nudge_y = 0.15, 
    check_overlap = T
  ) +
  labs(fill="Environmental suitability (Mean)") +
  theme(legend.position = "top") +
  commune_fill

#province_oncho_mosquito_map




x <- angola_oncho_mosquito_map + province_oncho_mosquito_map

# Focus on Quibala & Ganda
kib_gan_map <- angola_commune_oncho_collapse %>% 
  filter(adm3_en %in% c('kibala', 'ganda')) %>% 
  ggplot() +
  geom_sf(aes(fill = oncho_mean_aw)) +
  geom_sf_label_repel(aes(label = adm3_en)) +
  geom_point(
    data = mosquito_sampling_sites %>% filter(sentinel.site %in% c('Quibala', 'Ganda')), aes(x = longitude, y = latitude),
    fill = "red", color = "red", alpha =1, size=4
  ) +
  labs(fill="Environmental suitability (Mean)") +
  theme(legend.position = "top") +
  commune_fill



kib_gan_shp <- angola_commune_oncho_collapse %>% 
  filter(adm3_en %in% c('kibala', 'ganda'))

#Add raster data
africa_oncho_raster <- raster::raster(here('data', 'IHME_AFRICA_ONCHO_ENV_SUIT_MEAN_Y2020M08D26.TIF'))

kib_gan_raster_crop <- mask(africa_oncho_raster, kib_gan_shp)

kib_gan_raster_crop <- crop(africa_oncho_raster, kib_gan_raster_crop)

kib_gan_raster_point_df  <-  rasterToPoints(kib_gan_raster_crop) %>% as_tibble() 
colnames(kib_gan_raster_point_df) = c("lon", "lat", "suitability")

myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")))
sc <- scale_fill_gradientn(colours = myPalette(100), limits=c(1, 100))

kib_gan_raster_map <- ggplot() +
  #geom_sf() +
  geom_tile(data = kib_gan_raster_point_df %>% filter(suitability>=50), aes(lon, lat, fill = suitability), alpha = .7) +
  geom_sf(fill = "transparent", color = "black", size = 1.5, 
          data = kib_gan_shp) +
  geom_sf_label_repel(data=kib_gan_shp,aes(label = adm3_en)) +
  geom_point(
    data = mosquito_sampling_sites %>% filter(sentinel.site %in% c('Quibala', 'Ganda')), aes(x = longitude, y = latitude),
    fill = "red", color = "red", shape=8, alpha =1, size=4
  ) +
  labs(fill='Environmental suitability') +
  theme(legend.position='top') +
  sc +
  north(kib_gan_shp) +
  scalebar(kib_gan_shp, dist = 25, dist_unit = "km",
           transform = TRUE, model = "WGS84")




#Read in lakes and format file
rivers <-
  sf::st_read(here('data','input','rivers', 'afrivs.shp'))

rivers_interest <- sf::st_intersection(rivers,kib_gan_shp)

kib_gan_rivers_map <- ggplot() +
  #geom_sf() +
  geom_tile(data = kib_gan_raster_point_df %>% filter(suitability>=50), aes(lon, lat, fill = suitability), alpha = .7) +
  geom_sf(fill = "transparent", color = "black", size = 1.5,
          data = kib_gan_shp) +
  geom_sf_label_repel(data=kib_gan_shp,aes(label = adm3_en)) +
  geom_sf(data=rivers_interest, col="blue", lwd=0.4) +
  geom_point(
    data = mosquito_sampling_sites %>% filter(sentinel.site %in% c('Quibala', 'Ganda')), aes(x = longitude, y = latitude),
    fill = "red", color = "red", shape=8, alpha =1, size=4
  ) +
  labs(fill='Environmental suitability') +
  theme(legend.position='top') +
  sc +
  north(kib_gan_shp) +
  scalebar(kib_gan_shp, dist = 25, dist_unit = "km",
           transform = TRUE, model = "WGS84")

kib_gan_rivers_map

ggsave(here('images',"angola_oncho_mosquito_map.png"),angola_oncho_mosquito_map)
ggsave(here('images',"province_oncho_mosquito_map.png"),province_oncho_mosquito_map)
ggsave(here('images',"kib_gan_map.png"),kib_gan_map)
ggsave(here('images',"kib_gan_raster_map.png"),kib_gan_raster_map)
ggsave(here('images',"kib_gan_rivers_map.png"),kib_gan_rivers_map)

```

