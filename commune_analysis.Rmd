---
title: "Commune Analysis"
author: "Dave Kennedy"
date: "24/02/2022"
output:
  html_document: 
  keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      cache=TRUE,
                      dev="png",
                      dpi = 300,
                      fig.width = 6,
                      fig.asp = 0.8,
                      fig.retina = 2,
                      out.width = "100%")
require(pacman)
library(tidyverse)
pacman::p_load(raster, sf, exactextractr, here,
               readxl, tidyxl, unpivotr,
               leaflet, leaflet.extras, 
               janitor, patchwork,RColorBrewer,
               ggsflabel,broom,kableExtra,ggthemes,
               ggsn,gghighlight,ggsflabel,ggbeeswarm,
               data.table,linelist,tidylog, patchwork)

commune_palette <- colorRampPalette(rev(brewer.pal(5, "Spectral")))
commune_fill <- scale_fill_stepsn(n.breaks = 6, colours = viridis::viridis(6), limits=c(1, 100))
```

```{r data-wrangling}
# Import shapefiles 
iu_shp <-
  read_sf(here('data', 'input', 'shp', 'ESPEN_IU_2020.shp')) %>%
  filter(ADMIN0 == 'Angola') %>% 
  select(IU_ID,ADMIN1, ADMIN2, geometry)

# 164 implementation units

commune_shp <- read_sf(here('data', 'input', 'shp', 'ago_admbnda_adm3_gadm_ine_ocha_20180904.shp')) %>% 
  select(ADM1_EN, ADM1_PCODE, ADM2_EN,ADM2_PCODE, ADM3_EN,ADM3_PCODE, geometry) %>% 
    clean_data()

# 539 communes 

adm1_shp <- commune_shp %>%
  group_by(adm1_en) %>%
  summarise()

# 18 provinces 

source(here('admin_db.R'))

commune_shp_linked <- commune_shp %>% 
  left_join(final_linked_db %>% 
              select('adm1_pcode', 'adm2_pcode', 'adm3_pcode','iu_id'),
            by=c('adm1_pcode', 'adm2_pcode', 'adm3_pcode'))


# Import oncho data from ESPEN
ang_espen_data <-
  read.csv(here('data', 'input', 'espen_platform_oncho.csv')) %>%
  filter(Year == 2020) %>% 
  select(IU_ID, Endemicity, population=PopTot)

# 164 IUs

loa_loa_wd <-
  read.csv(here('data', 'input', 'espen_platform_loaloa.csv')) %>% 
  rename(loaloa_status = Endemicity) %>% 
  filter(Year==2020) %>% 
  select(IU_ID, loaloa_status)
# 164 IUs

unknown_commune_shp <- commune_shp_linked %>% 
  left_join(ang_espen_data, by=c('iu_id' = 'IU_ID')) %>% 
  filter(grepl('Unknown', Endemicity)) %>% 
  select(-Endemicity) %>% 
  left_join(loa_loa_wd, by=c('iu_id' = 'IU_ID')) %>% 
  mutate(oncho_status="Unknown")
  

# 398 communes
# 112 IUs

```

```{r map-angola-commune}
# Map to check data
iu_commune_map_labels <- adm1_shp %>%
  ggplot() +
  geom_sf(fill = "transparent", color = "black", size = 1.5) +
  geom_sf_label_repel(aes(label = adm1_en))

iu_commune_map_labels

iu_commune_endemicity <- iu_shp %>% 
  left_join(ang_espen_data, by='IU_ID') %>% 
  ggplot() +
  geom_sf(aes(fill = Endemicity),
    size = 0.05) +
        geom_sf(fill = "transparent", color = "black", size = 1.5,
            data=adm1_shp) +
        theme(legend.position = "top")

iu_commune_endemicity

iu_commune_map <- unknown_commune_shp %>%
  ggplot() +
  geom_sf(aes(fill = oncho_status)) +
    geom_sf(fill = "transparent", color = "black", size = 1.5,
            data=adm1_shp) +
      theme(legend.position = "top")

iu_commune_map

```

```{r raster-wrangling}

#Import environmental suitability as raster data
africa_oncho_rs <-
  stack(here('data', 'IHME_AFRICA_ONCHO_ENV_SUIT_MEAN_Y2020M08D26.TIF'))

#Crop raster to shapefile of communes within IUs with unknown endemicity
unknown_iu_oncho_combined <-
  exact_extract(africa_oncho_rs,
                unknown_commune_shp,
                progress = FALSE)  %>%
  bind_rows(., .id = "id") %>%
  as_tibble() %>% 
  mutate(id = as.numeric(id)) %>%
  #--- group summary ---#
  filter(!is.na(value))

# Merge raster values with shapefile
angola_commune_oncho <- unknown_commune_shp %>%
  mutate(id := seq_len(nrow(.))) %>%
  left_join(., unknown_iu_oncho_combined, by = "id") 

```

```{r}
#Calculate weighted mean
# angola_commune_oncho_collapse <- angola_commune_oncho %>%
#   group_by(adm1_en, adm2_en, adm3_en) %>%
#   summarise(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))  

angola_commune_oncho_collapse <- setDT(angola_commune_oncho)[, keyby = .(adm1_en, adm2_en, adm3_en), 
                          .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%  
  merge(unknown_commune_shp, all=TRUE, by = c('adm1_en', 'adm2_en','adm3_en')) %>% 
  st_as_sf()

# y <- merge(unknown_commune_shp, angola_commune_oncho_collapse, all = TRUE, by = "Id")
# 
# angola_commune_oncho_collapse <- merge(unknown_commune_shp, angola_commune_oncho_summary, all.x = TRUE, by = c('adm1_en', 'adm2_en','adm3_en'))

# Map weighted mean by ADM3  
angola_commune_oncho_noloaloa_map <- angola_commune_oncho_collapse %>% 
  ggplot() +
  geom_sf(aes(fill = oncho_mean_aw)) +
     geom_sf(fill = "transparent", color = "black", size = 1.5,
          data = adm1_shp) +
  commune_fill

angola_commune_oncho_noloaloa_map
```



Check environmental suitability by Loa loa endemicity

```{r loa-loa}

oncho_env_loaloa_compare <- ggplot(data=angola_commune_oncho, 
                                    aes(x=value, group=loaloa_status, fill=loaloa_status)) +
    geom_density(adjust=1.5, alpha=.4) +
    labs(x="Environmental suitability", fill="Loa loa status") +
    theme_tufte()
  
oncho_env_loaloa_compare

 (oncho_env_loaloa_ttest <- t.test(value ~ loaloa_status, 
                                   data = angola_commune_oncho, 
                                   var.equal = TRUE) %>% 
    tidy())
  
```

```{r country-commune-noloaloa-map}
#Calculate weighted mean
# angola_commune_oncho_noloaloa_collapse <- angola_commune_oncho %>%
#   filter(loaloa_status == "Non-endemic") %>% 
#   group_by(adm1_en, adm2_en, adm3_en) %>%
#   summarise(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))

angola_commune_oncho_noloaloa_collapse <- setDT(angola_commune_oncho)[
  loaloa_status == "Non-endemic"] [
  , keyby = .(adm1_en, adm2_en, adm3_en), 
                          .(oncho_mean_aw = sum(value * coverage_fraction) / sum(coverage_fraction))] %>%  
  merge(unknown_commune_shp, by = c('adm1_en', 'adm2_en','adm3_en')) %>% 
  st_as_sf()

# Map weighted mean by ADM3  
(angola_commune_oncho_noloaloa_map <- angola_commune_oncho_noloaloa_collapse %>% 
  ggplot() +
  geom_sf(aes(fill = oncho_mean_aw)) +
     geom_sf(fill = "transparent", color = "black", size = 1.5, 
          data = adm1_shp) +
    commune_fill)

commune_boxwhisker <- angola_commune_oncho %>% 
  filter(loaloa_status == "Non-endemic") %>% 
  mutate(location_name=paste(adm1_en,adm3_en, sep= "-")) %>% 
  split(.$location_name) %>%
  imap(~ ggplot(data=.x) +
        geom_boxplot(aes(value, reorder(adm3_en,desc(adm3_en)))) + 
        theme_bw() +
        scale_x_continuous(limits=c(0,100),sec.axis = dup_axis()) +
        labs(x='Environmental suitability', 
             y='Commune') +
          ggtitle(.y) 
  )


commune_map <-  angola_commune_oncho_noloaloa_collapse %>%
  mutate(location_name=paste(adm1_en,adm3_en, sep= "-")) %>% 
  split(.$location_name) %>%
  imap(~ ggplot(data = .x) +
      geom_sf(aes(fill = oncho_mean_aw)) +
      geom_sf_label_repel(aes(label = adm3_en)) +
      theme(legend.position = 'top') +
      labs(x = "", y = "", fill = "Environmental suitability") +
      commune_fill +
      ggtitle(.y)
  )

all_plots <- map2(commune_map,commune_boxwhisker,~{.x / .y})

```


```{r population_data}
#https://medium.com/@samukweku/reshaping-an-excel-table-in-r-71d7d9020124

#sourcefile
filename <- here('data/input/Estimativas_Comunais_Geral_Final.xlsx')
#get list of sheet_names
#which also represents the company names
sheet_names <- xlsx_sheet_names(filename)#read in file, using the tidyxl package
#filter for only character and numeric
#and pick specific rows and columns
def <- function(sheetname){xlsx_cells(filename,sheetname)%>%
    filter(data_type %in% c("character","numeric"), 
           row >=5, 
           col >=1)}
#stage1
#apply function to sheetnames
#using the purrr library
stage1 <- map(sheet_names, def)

def_main <- function(datum){datum%>%
    select(sheet,row,col,data_type,character,numeric)%>%
    #behead("NNE",years)%>%
    behead("N",commune)%>%
    fill(character, .direction = "down") %>% 
    filter(!is.na(commune))
  }#apply function to every tibble in stage1
stage2 <- map(stage1,def_main)

commune_pop_append <- bind_rows(stage2) %>% 
  select(province=sheet,commune, age_group=character, population=numeric)  %>% 
  dplyr::filter(!is.na(population))  %>% 
  clean_data() %>% 
  filter(!grepl("estimativ", commune, ignore.case=TRUE)) %>% 
  filter(!grepl("estimativ", age_group, ignore.case=TRUE)) %>%
  filter(!grepl("controlo", commune, ignore.case=TRUE)) %>% 
  filter(age_group!='total') %>% 
  mutate(commune=case_when(commune=="quibocolo" ~ "kibocolu", 
                           TRUE ~ commune))
  
province_commune_match <- commune_pop_append %>%
  filter(province==commune | commune=="chitato" | commune=="bengo" | commune=="caiongo") %>%
  group_by(province,commune,age_group) %>%
  slice(which.min(population))

province_commune_population <- commune_pop_append %>%
  filter(!commune %in% c("chitato","bengo","caiongo")) %>% 
  filter(province!=commune) %>% 
  bind_rows(province_commune_match) %>% 
  #mutate(row = row_number()) %>%
  pivot_wider(id_cols=c('province','commune'), names_from=age_group, values_from=population) 
  #pivot_wider(names_from=age_group, values_from=population) %>%  
  #select(-row)

commune_pop_clean <- province_commune_population %>% clean_data()

oncho_pop_shp <- angola_commune_oncho_collapse %>% clean_data %>% 
  left_join(commune_pop_clean, by=c('adm1_en'='province', 'adm3_en'='commune')) 

oncho_pop_table <- oncho_pop_shp %>% 
  as_tibble() %>% 
  select(-geometry) %>% 
  clean_names() %>% 
  mutate(pop_data=ifelse(!is.na(x0_4_anos), "Yes", "No"))
  
```


```{r eval=FALSE, fig.height=12, fig.width=12, include=FALSE}
all_plots
```

